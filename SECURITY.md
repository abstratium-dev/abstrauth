# Security Implementation

This document describes the JWT-based security implementation for the abstrauth OAuth2 authorization server.

## Overview

The application uses **Quarkus SmallRye JWT** for securing REST endpoints with role-based access control (RBAC). JWT tokens are signed using PS256 (RSA-PSS with SHA-256) algorithm.

## Architecture

### Token Generation
- Tokens are generated by the OAuth2 authorization flow in `TokenResource`
- Private key is configured via `smallrye.jwt.sign.key` property
- Algorithm: PS256 (RSA-PSS with SHA-256)
- Issuer: `https://abstrauth.abstratium.dev`

### Token Verification
- Tokens are verified using the public key extracted from the private key
- Public key is configured via `mp.jwt.verify.publickey` property
- Issuer validation ensures tokens are from the correct authorization server
- Signature validation ensures token integrity

### Role-Based Access Control
- Roles are extracted from the `groups` claim in the JWT
- The `@RolesAllowed` annotation protects endpoints
- Role naming convention: `<client_id>_<role_name>` (e.g., `abstratium-abstrauth_manage-clients`)
- Universal roles (e.g., `user`) are automatically prefixed with the client ID when added to tokens

### Default Roles

All authenticated users receive default roles configured per environment:

**Development/Test/E2E**:
```properties
%dev.default.roles=user,abstratium-abstrauth_manage-clients
%test.default.roles=user,abstratium-abstrauth_manage-clients
%e2e.default.roles=user,abstratium-abstrauth_manage-clients
```

**Production**:
```properties
%prod.default.roles=user
```

**Role Formats**:
- `user` - Universal role, auto-prefixed with client ID (becomes `abstratium-abstrauth_user`)
- `abstratium-abstrauth_manage-clients` - Client-specific role, only added if client ID matches

**Security Note**: Development environments grant `manage-clients` role by default for convenience. Production environments should only grant the basic `user` role, with additional roles assigned explicitly via the database (`T_account_roles` table).

## Configuration

### Key Management

The application uses a single RSA key pair for signing and verification:

**Private Key** (for signing tokens):
```properties
%dev.smallrye.jwt.sign.key=<base64-encoded-private-key>
%test.smallrye.jwt.sign.key=${%dev.smallrye.jwt.sign.key}
%prod.smallrye.jwt.sign.key=SET-USING-ENV-VAR
```

**Public Key** (for verifying tokens):
```properties
%dev.mp.jwt.verify.publickey=<base64-encoded-public-key>
%test.mp.jwt.verify.publickey=${%dev.mp.jwt.verify.publickey}
%prod.mp.jwt.verify.publickey=SET-USING-ENV-VAR
```

### Extracting Public Key

To extract the public key from the private key, use the provided script:

```bash
./extract-public-key.sh
```

This will output the public key in base64 format for use in `application.properties`.

### JWT Verification Settings

```properties
# Algorithm used for signature verification
mp.jwt.verify.publickey.algorithm=PS256

# Expected issuer claim value
mp.jwt.verify.issuer=https://abstrauth.abstratium.dev

# Map 'groups' claim to roles for @RolesAllowed
smallrye.jwt.path.groups=groups
smallrye.jwt.claims.groups=groups
```

## Protected Endpoints

### `/api/clients` - OAuth Client Management

**Protection**: `@RolesAllowed("abstratium-abstrauth_manage-clients")`

**Required Role**: `abstratium-abstrauth_manage-clients`

**Behavior**:
- **No token**: Returns HTTP 401 Unauthorized
- **Invalid token**: Returns HTTP 401 Unauthorized
- **Valid token without required role**: Returns HTTP 403 Forbidden
- **Valid token with required role**: Returns HTTP 200 OK with client list

### `/api/signup` - User Registration

**Protection**: `@PermitAll`

**Behavior**:
- Publicly accessible (no authentication required)
- Subject to `allow.signup` configuration property

## Angular HTTP Interceptor

The Angular frontend automatically adds JWT tokens to API requests via `authInterceptor`:

**Behavior**:
- Adds `Authorization: Bearer <token>` header to all `/api/*` requests
- Only adds token when user is authenticated (`authService.isAuthenticated()`)
- Does not modify requests to other paths (e.g., `/oauth2/*`, `/.well-known/*`)

**Implementation**: `src/main/webui/src/app/auth.interceptor.ts`

## Testing

### Backend Tests

Tests use `io.smallrye.jwt.build.Jwt` to generate test tokens:

```java
// Generate valid token with required roles
String token = Jwt.issuer("https://abstrauth.abstratium.dev")
    .upn("test@example.com")
    .groups(Set.of("abstratium-abstrauth_user", "abstratium-abstrauth_manage-clients"))
    .claim("email", "test@example.com")
    .claim("name", "Test User")
    .sign();

// Use token in request
given()
    .header("Authorization", "Bearer " + token)
    .when()
    .get("/api/clients")
    .then()
    .statusCode(200);
```

**Note**: In test environments, default roles (`user`, `manage-clients`) are automatically added to all tokens. Tests can override this by explicitly setting the `groups` claim.

### Test Coverage

The `ClientsResourceTest` includes:
- âœ… Returns 401 when no token is provided
- âœ… Returns 401 when invalid token is provided
- âœ… Returns 403 when valid token lacks required role
- âœ… Returns 200 when valid token with required role is provided
- âœ… All functional tests updated to use valid tokens

### Angular Tests

The Angular interceptor has comprehensive tests covering:
- âœ… Adds Authorization header to `/api/*` requests with JWT
- âœ… Does not add header when user is not authenticated
- âœ… Does not add header to non-API requests
- âœ… Handles token changes and signout correctly

## Security Best Practices

### âœ… Implemented

1. **Token Signature Verification**: All tokens are cryptographically verified using RSA-PSS
2. **Issuer Validation**: Tokens must be issued by `https://abstrauth.abstratium.dev`
3. **Role-Based Access Control**: Fine-grained permissions using `@RolesAllowed`
4. **Proper HTTP Status Codes**: 401 for authentication failures, 403 for authorization failures
5. **Secure Key Management**: Private keys configured via environment variables in production
6. **Token Expiration**: Tokens include `exp` claim (handled by SmallRye JWT automatically)
7. **HTTPS in Production**: Recommended via reverse proxy configuration

### ðŸ”’ Production Deployment

For production deployment:

1. **Set environment variables**:
   ```bash
   export SMALLRYE_JWT_SIGN_KEY="<your-private-key>"
   export MP_JWT_VERIFY_PUBLICKEY="<your-public-key>"
   ```

2. **Generate production keys**:
   ```bash
   # Generate new RSA key pair
   openssl genpkey -algorithm RSA -out privateKey.pem -pkeyopt rsa_keygen_bits:2048
   
   # Extract public key
   openssl rsa -in privateKey.pem -pubout -out publicKey.pem
   
   # Convert to base64 (no headers/newlines)
   grep -v '^-----' privateKey.pem | tr -d '\n'
   grep -v '^-----' publicKey.pem | tr -d '\n'
   ```

3. **Use HTTPS**: Configure reverse proxy (nginx, Apache, etc.) to terminate TLS

4. **Rotate keys periodically**: Update keys and redeploy application

## Troubleshooting

### Common Issues

**401 Unauthorized with valid token**:
- Check issuer claim matches `mp.jwt.verify.issuer`
- Verify public key matches the private key used for signing
- Ensure token is not expired

**403 Forbidden with valid token**:
- Verify user has the required role in `groups` claim
- Check role name matches exactly (case-sensitive)

**Token not being sent from Angular**:
- Verify user is authenticated (`authService.isAuthenticated()`)
- Check browser console for interceptor errors
- Ensure request URL starts with `/api/`

## References

- [Quarkus Security JWT Guide](https://quarkus.io/guides/security-jwt)
- [MicroProfile JWT RBAC Specification](https://github.com/eclipse/microprofile-jwt-auth)
- [RFC 7519 - JSON Web Token (JWT)](https://tools.ietf.org/html/rfc7519)
- [RFC 8725 - JWT Best Current Practices](https://tools.ietf.org/html/rfc8725)
