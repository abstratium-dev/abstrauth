# don't use dev services, use a real database
quarkus.devservices.enabled=false

quarkus.datasource.db-kind=mysql
%dev.quarkus.datasource.username=abstrauth
%dev.quarkus.datasource.password=secret
%dev.quarkus.datasource.jdbc.url=jdbc:mysql://localhost:41040/abstrauth

# E2E Testing Profile - Uses H2 in-memory database
%e2e.quarkus.datasource.db-kind=h2
%e2e.quarkus.datasource.jdbc.url=jdbc:h2:mem:e2e;DB_CLOSE_DELAY=-1
%e2e.quarkus.datasource.username=sa
%e2e.quarkus.datasource.password=

quarkus.hibernate-orm.schema-management.strategy=none
%dev.quarkus.hibernate-orm.log.sql=false

quarkus.flyway.migrate-at-start=true

quarkus.log.console.format=%d{yyyy-MM-dd HH:mm:ss,SSS} %-5p [%c{3.}] (%t) [skey:%X{abstratiumkey}] %s%e%n
quarkus.log.level=INFO
%dev.quarkus.log.category."dev.abstratium".level=DEBUG
%dev.quarkus.log.category."io.quarkus.quinoa".level=DEBUG
%dev.quarkus.log.category."io.quarkus.oidc".level=DEBUG
%dev.quarkus.log.category."io.quarkus.oidc.runtime".level=DEBUG

# because we are behind proxy. see https://quarkus.io/guides/http-reference#reverse-proxy
quarkus.http.proxy.allow-forwarded=true
quarkus.http.proxy.proxy-address-forwarding=true
quarkus.http.proxy.enable-forwarded-host=true
quarkus.http.proxy.enable-forwarded-prefix=true

# Increase worker thread pool to handle OIDC JWKS fetch during startup
# This prevents worker thread exhaustion when server connects to itself
quarkus.thread-pool.max-threads=20

%dev.allow.signup=false
%test.allow.signup=true
%e2e.allow.signup=true
%prod.allow.signup=false

allow.native.signin=true

# Password pepper - application-wide secret for additional password security
# CRITICAL: Must be stored as environment variable in production
# WARNING: Changing this value requires re-hashing all existing passwords
# Generate with: openssl rand -base64 32
password.pepper=${PASSWORD_PEPPER:dev-pepper-CHANGE-IN-PRODUCTION-SEE-LINE-ABOVE}

# https://quarkus.io/guides/security-jwt-build
# from sign() method in JwtClaimsBuilder:
# Keys in PEM, JWK and JWK formats are supported.
# 'RS256' algorithm will be used unless a different algorithm has been set with 
# JwtSignatureBuilder or 'smallrye.jwt.new-token.signature-algorithm' property. 
# A key of size 2048 bits or larger MUST be used with the 'RS256' algorithm.
# The smallrye.jwt.sign.key property can also contain 
# a Base64-encoded private key value directly.
#
# generate the key:
# openssl genpkey -algorithm RSA -out /tmp/privateKey.pem -pkeyopt rsa_keygen_bits:2048
# # Extract the public key (optional, for verification)
# openssl rsa -in /tmp/privateKey.pem -pubout -out /tmp/publicKey.pem
# # remove the header/footer and newlines
# grep -v '^-' /tmp/privateKey.pem | tr -d '\n'
# copy the result and paste it into the smallrye.jwt.sign.key property below, or set the relevant env var.
# If not set, then expect an error that says something like the key cannot be extracted
#%dev.smallrye.jwt.sign.key=LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tTUlJRXZBSUJBREFOQmdrcWhraUc5dzBCQVFFRkFBU0NCS1l3Z2dTaUFnRUFBb0lCQVFDbjdvS1kxWURJYit1UVRiNTVOd2YvTTQ2Z3VNTUJXaGxDbkxXc2JLcTZNVWRjQkg3dlFVNGlDaXBLWnZlbW45NnNkd3RoNlFMNHhvQS9uV2kwM3J2NS9aQTQ1VE9YM0sveVZGNnA5c0swZDBoYkl6SHhtcEVQbWdzVGRKUmFoclpBNU8yRDNVQTdmYlNEWm13Myt2aUZSMzhVWW9pTERXbnZyUmk3YnV1K0RNbEhqSEVVcWJXUEw3RXB0V0xJSG9EL0FuVjBEVG9WcVFFb3BCdHdPOFE2engxM1RSbEJrTjlXZnpPQXhvQkdRUzlXUmlKSVUrS09wTEp5bUw1OFJ1Ulp6V1NpaHYzSGxaQTBvUXBrQVFWKzFSRXl0Vmdtc3VqcUFJUVRWNkd1Y0JLMkxTTE40N0JkMlRwRGljOFFxU2xua2VtR3hGTFpNeGg2WkdMVWorb0JBZ01CQUFFQ2dnRUFJWWsyVCs2dE0vbnoxVUxOVTdncmN1bTVKVHdZaDF2V21SQ2lFRCs0UFl3clI4TkhGU0VaeVI3MkVKc3RBRHZEZEhZbWtnUStPVytzdTJlRU9rQ1QwZ255NUFYVHJwTmVHTHNFRjVXbGp2UVdRVXNQUllROFRWMFNNcTJ3bGI1NnhZMWlLRmdHSkl0SFFnbHhlYUYzUVdpRWhvM2gza0VNdzVZeUR2WkpBbEFJeWMrcXB1b3YwenJNTkVPbTYyTzdNMmNYSHhaZzhkSkhjdTVWNlgvUVpENCtSSXBOUXNFZXVacWJJWmQ2UmMyTE5BODNqNHZDWWZVN3FNbncvN0JBVUxhOHdFbFNNZHNzRjJyVnJHcVlhY2FzRzJwRGQ1NStOcHpUUVdUazZvekFjY0JWbkY1NDJPQVo2Y2lSRktNeDFQUEZqa0tIT2pBcXVJNng3Y2xrZFFLQmdRRGd4YTdaZHFiRE5XR3BwTFhidjBWQ2xQOXhkVGI2UG1mY0pZVnBTMDZ3NjZvRy95ZEdhN3VqTXFtZlFmZmFRbUpzTEMyS0RvTHVHa0lTNmNMZzFIMFgyRldNOVpwV2poQVErQXc1dGtvcXJYbWx5b3RSZC94Wjc5QTlUMEM2aU45WmQ3UkN5YkprSktrbzZmVk5WdWVhaVpZVWZWTjYvNzdIaUhzN3hVR2xiUUtCZ1FDL1F6aEUvM2dHWUpSOVBlaTl0YWtqY0JnZTVHcDJPK3JFR01DOXZLZlZqU1gzdjg5ekJLY2QrVUUvdUxXcHM1NHhtc2pORUJLL1RodkJCckxzOGJKZ0ZyVUYxNWdBYVVRTW90bEl2QkQyWm5wa0FhcDhVZjBJVmtOUHFCN0hsbHM3TTlOdjI5R0x4SmNJUlhVMmhHb3JFcGJNWGIweWEwYzl4c0h0K25aK1pRS0JnSGNaaUVxR1NsckpZRlJwaUV0R0VFYjFlRjBBQlArWUxhUkM1V3dqa1REQnpyZ2lYd2M3Y3BOSTl3UUNDbmpHRUN6TlE5d1JVR01sMnJqMjBHSWRkYU02NkNubXdiNzNTNkFTTHpndFZTTkVCRjlLOFlOYmxvVjVRdGdadEd5aXRlWk1QV0hlU2Y0eVJzZjlJQk80NXNQRi81WWZ5aW8wZFR4NUh3Tk94RGdKQW9HQUxmbndxdFZtZXRING4rcWo2Z2FqTS91Y01NRGp2cXhFa1FNS1FoSDVubUlod0Y2QmRicW1tWlB6VldnSGMxWFVMMFJ3Qkt0YWRsWkdZYTVFa0tUQkprd1BFK3B4aFpmSVhlay9walpmTlh3STY4Vml3Q1BOV1pXeTlKRUxaUnNGcjBPVURnMmZYNlBRVXBLdnpIMGtNRnAxbVlibkZobW50SGYwNGtvVTlla0NnWUE2QTdabmJEWkI5WjNTT1FoRGtvN1dLOFBCdnRlSDdvaCtYZDdOd1d6eHJScmdDemdBYURZWmNWeWI4TXJ1Zy8wbnArYjJNdVlZRE9MQnZFTkVVM0IwT2t2bVdPUHlYRmhwbld2WUNqclFlUEhYVFJZd1FKZGRKRjhjdWhuT1JUSVdKejdYSVgydldMd2djVGc2a3NNcGZDS212RkcvYUZYYlhld0dPOTVKVmc9PS0tLS0tRU5EIFBSSVZBVEUgS0VZLS0tLS0=
%dev.smallrye.jwt.sign.key=MIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQDBvM+riIoEaxItLtOU0or3kQ3P9Om7pN4NmM32ONMJxHSn6n+GpineEGeCdyFcE5OkRF0a6BrDANXDUfhGQccnN6u6BalIebF0pVBpyra+i9Wcpbb1dixZgm6cgROm1ZDqSfIGnx48PsMqHM/EE6LLHeiB8V/bdmd01eiRg/LAp8q7BZJGBlDZUNmedP/bkcU8szBT8X6ZD4btiITDZZKxLWtgZsEJmF0tt90gDSBy5pU/ewwUrTMaCTj2eQgQ5AfefMZ6tJT6phYBEFyWPTEkkS+ulJct0xt3rPrekcseeAdM61FdtaOdSr+TvWbVRp7s5qSobT9qaCM5+4bnPv9bAgMBAAECggEAAJfcEuxiGngGyuNKe+Qrz2zpm+oQunsGFbM9aN7tASn8KXTLBdXbFEunOtEJOxzxkMkyInOffAVeojB4ECRXaxlSifPxJsBTTht2JDzIqSCzJhL5J8Xq24NOD2XzHMmpSJkICAPTYIqDUnewHdY+41xTapfF8V1qx613/tS77jcT8Qar556YTccJu0qgwNlrapjQYRvV5wT2uV4JqYaN1vC3tNXlIIsCGNR2CN9S/s6jp/gOE+eqfCbiuON1jCbXbN0U1TL4WKj6OYsOiA27hGCJ6n17gMBou+t8T8MccuceV9Lb8ecXB6h/oUok9gqZ57om8dGVoP4hZaOPsSWXwQKBgQDwRMCmunAe9d64yoUQYqmfHKtW584ltIr4do0hpaOsGXTjmrueG10BhFXPlDYoU1BWRezTQXVxWcPoLeIFFA511H22nRQ4g/dvBibCUr8B33jpGfbUq1baMrp2GN2KYdVbChEtrWPGNZCtXeux9sLuoDZVXbakdr4frAEDna+Q0QKBgQDObCG2cW8rdbh+0BOZY2x82titS4uE4Nx8LpF2Yl8zyFa/n+eRyXzhZXtQvEka04IX7SqncOMPYPen0pCAgd3DvoGTVcxRB0d2sCJ9oY++A4kEoUprddcQXwhWGqPTATosVbr3V2XwAx58yvG0odZBUN466shR7FEQmzbmviP4awKBgQDCx2nKgC/u2XHSKtPOob1SsQIx9L/JD2Dt5eWp1kcmeIirD0Bz/0jZtvd9zXBOJqRlHFDOPi3AU34fFjs51LWYTkgPp63B1zHa/oijVkNkeE7j4dmZNMG3KBLDNIs86Oz23eVpOzw8biY4dYBiiGIk4xrI/6zWDTE6Kc20qbuvUQKBgGYoWZ7jELOfdQk9jRWSgPRhkm5hPtEqP7Qtj8vY72i/Mz9usboSz3z1LkxMgpmGJ5ITy9JGKflIcghaSy1uGARx2crC4XUQdyukC83FEVBmi38BG8WG8kKl5YhHcuBQcSvT2c3jMQ3RXVtBTNGqblCw5uqdmzoADDZ9unQDkeW1AoGBALy9D8nFqZQB9i4fPeve9kTLd4wgyB8KrpTGtKnIcDOqjQcA2DA+mG/vzuAxP2ie4/QnCPAxzHtmLTKMAjzxNHgB+6zGYT+zBOgFdWqfUHz14DisHoSICkwaKluTBeVZYakQb0g57TvtfagvNf9ADuiCorbYot7yxoG+IRCDCauw
%test.smallrye.jwt.sign.key=${%dev.smallrye.jwt.sign.key}
%e2e.smallrye.jwt.sign.key=${%dev.smallrye.jwt.sign.key}
%prod.smallrye.jwt.sign.key=SET-USING-ENV-VAR

smallrye.jwt.new-token.signature-algorithm=PS256

# JWT Verification Configuration
# Public key for verifying JWT signatures (extracted from private key using extract-public-key.sh)
# To regenerate: ./extract-public-key.sh
# if not set, then you will get 401 errors when trying to load accounts, clients, etc.
%dev.mp.jwt.verify.publickey=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAwbzPq4iKBGsSLS7TlNKK95ENz/Tpu6TeDZjN9jjTCcR0p+p/hqYp3hBngnchXBOTpERdGugawwDVw1H4RkHHJzerugWpSHmxdKVQacq2vovVnKW29XYsWYJunIETptWQ6knyBp8ePD7DKhzPxBOiyx3ogfFf23ZndNXokYPywKfKuwWSRgZQ2VDZnnT/25HFPLMwU/F+mQ+G7YiEw2WSsS1rYGbBCZhdLbfdIA0gcuaVP3sMFK0zGgk49nkIEOQH3nzGerSU+qYWARBclj0xJJEvrpSXLdMbd6z63pHLHngHTOtRXbWjnUq/k71m1Uae7OakqG0/amgjOfuG5z7/WwIDAQAB
%test.mp.jwt.verify.publickey=${%dev.mp.jwt.verify.publickey}
%e2e.mp.jwt.verify.publickey=${%dev.mp.jwt.verify.publickey}
%prod.mp.jwt.verify.publickey=SET-USING-ENV-VAR

# JWT verification settings
mp.jwt.verify.publickey.algorithm=PS256
mp.jwt.verify.issuer=https://abstrauth.abstratium.dev

# Map the 'groups' claim in JWT to roles for @RolesAllowed
smallrye.jwt.path.groups=groups
smallrye.jwt.claims.groups=groups

# ============================================================================
# Security Configuration
# ============================================================================

# Session timeout in seconds (15 minutes = 900 seconds)
# This value is used for:
# - JWT token expiration (access_token and id_token)
# - OIDC session cookie max-age
# - Angular session expiry timer
abstrauth.session.timeout.seconds=900

# ============================================================================
# OIDC Configuration - BFF tenant for /api/* endpoints only
# ============================================================================
# Use a named tenant that only applies to /api/* paths
# This prevents OIDC from intercepting /oauth2/* and /.well-known/* endpoints

# BFF tenant configuration
quarkus.oidc.bff.tenant-enabled=true
quarkus.oidc.bff.tenant-paths=/api/*
quarkus.oidc.bff.auth-server-url=http://localhost:8080
%prod.quarkus.oidc.bff.auth-server-url=https://auth.abstratium.dev

# Skip initial OIDC connection at startup - connect on first request instead
quarkus.oidc.bff.connection-delay=0S

# Disable discovery - configure all endpoints manually
quarkus.oidc.bff.discovery-enabled=false

# Manual endpoint configuration
quarkus.oidc.bff.authorization-path=/oauth2/authorize
quarkus.oidc.bff.token-path=/oauth2/token
quarkus.oidc.bff.jwks-path=/.well-known/jwks.json
quarkus.oidc.bff.end-session-path=/api/auth/logout

# Provide public key directly
quarkus.oidc.bff.public-key=${mp.jwt.verify.publickey:}
quarkus.oidc.bff.token.issuer=https://abstrauth.abstratium.dev

# Client credentials
quarkus.oidc.bff.client-id=abstratium-abstrauth
quarkus.oidc.bff.credentials.secret=${ABSTRAUTH_CLIENT_SECRET:dev-secret-CHANGE-IN-PROD}

# Token endpoint authentication - Basic Auth is now supported by TokenResource
# No additional config needed - Quarkus OIDC uses Basic Auth by default

# Application type: web-app (authorization code flow)
quarkus.oidc.bff.application-type=web-app

# PKCE configuration
quarkus.oidc.bff.authentication.pkce-required=true

# Scopes to request (openid is automatically added by Quarkus OIDC)
quarkus.oidc.bff.authentication.scopes=profile,email

# Redirect paths - must be under /api to match cookie-path
quarkus.oidc.bff.authentication.redirect-path=/api/auth/callback
quarkus.oidc.bff.authentication.restore-path-after-redirect=true

# Don't verify access token - we only need ID token for BFF authentication
# Access token is for API calls, not session management
# And the token comes from THIS server, so we can trust 
# it after having called our own API using TLS in prod, 
# since the hostname will have been verified
quarkus.oidc.bff.authentication.verify-access-token=false

# need to delay resolution until the server has actually started. this works on first startup,
# it doesn't work on hot reload, but we can live with that.
# quarkus.oidc.connection-time-out=1S
# quarkus.oidc.connection-delay=10S
quarkus.oidc.jwks.resolve-early=false

# Cookie configuration (HTTP-only, secure, encrypted) - scoped to BFF tenant
quarkus.oidc.bff.token-state-manager.strategy=id-refresh-tokens
quarkus.oidc.bff.token-state-manager.split-tokens=true
quarkus.oidc.bff.token-state-manager.encryption-required=true
quarkus.oidc.bff.token-state-manager.encryption-secret=${COOKIE_ENCRYPTION_SECRET:dev-encryption-key-must-be-at-least-32-chars-long}

# Session timeout - use centralized config (PT15M = 15 minutes = 900 seconds)
quarkus.oidc.bff.authentication.session-age-extension=PT${abstrauth.session.timeout.seconds}S

# Cookie settings - CRITICAL: scope to /api to prevent interference with /oauth2
quarkus.oidc.bff.authentication.cookie-path=/api
quarkus.oidc.bff.authentication.cookie-same-site=strict
%prod.quarkus.oidc.bff.authentication.cookie-secure=true

# Logout configuration
quarkus.oidc.bff.logout.path=/api/auth/logout
quarkus.oidc.bff.logout.post-logout-path=/

# Error handling configuration
quarkus.oidc.bff.authentication.error-path=/api/auth/error

# Forward these paths to Quarkus backend instead of Angular dev server
# TODO why do i need to keep this list sync with proxy.conf.json?
quarkus.quinoa.ignored-path-prefixes=/oauth2,/.well-known,/api

# Quinoa configuration - Angular is in src/main/webui and outputs to dist/abstrauth/browser
quarkus.quinoa.ui-dir=src/main/webui
quarkus.quinoa.build-dir=dist/abstrauth/browser
quarkus.quinoa.enable-spa-routing=true
quarkus.quinoa.package-manager-install=true
quarkus.quinoa.package-manager-install.node-version=24.11.1

# E2E Profile - Ensure Quinoa builds Angular app for e2e tests
%e2e.quarkus.quinoa.package-manager-install=true

# Google OAuth Configuration
# Get these values from Google Cloud Console: https://console.cloud.google.com/apis/credentials
# The following values are taken from environment variables (source /w/abstratium-abstrauth.env):
# - OAUTH_GOOGLE_CLIENT_ID
# - OAUTH_GOOGLE_CLIENT_SECRET

oauth.google.client-id=${OAUTH_GOOGLE_CLIENT_ID}
oauth.google.client-secret=${OAUTH_GOOGLE_CLIENT_SECRET}

%dev.oauth.google.redirect-uri=http://localhost:8080/oauth2/callback/google
%test.oauth.google.client-id=test-client-id
%test.oauth.google.client-secret=test-client-secret
%test.oauth.google.redirect-uri=http://localhost:8080/oauth2/callback/google
%e2e.oauth.google.client-id=test-client-id
%e2e.oauth.google.client-secret=test-client-secret
%e2e.oauth.google.redirect-uri=http://localhost:8080/oauth2/callback/google
%prod.oauth.google.redirect-uri=https://abstrauth.abstratium.dev/oauth2/callback/google

# Google OAuth REST Client Configuration
# Base URL: www.googleapis.com
# Token endpoint: /oauth2/v4/token
# Userinfo endpoint: /oauth2/v1/userinfo
quarkus.rest-client.google-oauth.url=https://www.googleapis.com
%test.quarkus.rest-client.google-oauth.url=http://localhost:${wiremock.server.port:8089}
%e2e.quarkus.rest-client.google-oauth.url=http://localhost:${wiremock.server.port:8089}

# Security Headers Configuration
# Content Security Policy - Protects against XSS, clickjacking, and code injection
security.csp.enabled=true
security.csp.policy=default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; img-src 'self' https://abstratium.dev; font-src 'self'; connect-src 'self'; frame-ancestors 'none'; base-uri 'self'; form-action 'self'

# HSTS (HTTP Strict Transport Security) - Forces HTTPS
# Disabled by default (dev/test/e2e use HTTP), enabled in production
security.hsts.enabled=false
security.hsts.max-age=31536000
security.hsts.include-subdomains=true
security.hsts.preload=true

# Enable HSTS in production (requires HTTPS)
%prod.security.hsts.enabled=true

# Rate Limiting Configuration
# OAuth endpoints are rate-limited to prevent abuse and brute-force attacks
# max-requests: Maximum number of requests allowed per window (default: 10)
# window-seconds: Time window in seconds (default: 60 = 1 minute)
# ban-duration-seconds: How long to ban an IP after exceeding limits (default: 300 = 5 minutes)
rate-limit.enabled=true
%dev.rate-limit.oauth.max-requests=1000
%test.rate-limit.oauth.max-requests=1000
%e2e.rate-limit.oauth.max-requests=1000
rate-limit.oauth.max-requests=100
rate-limit.oauth.window-seconds=60
rate-limit.oauth.ban-duration-seconds=300

# Disable rate limiting in test profile to avoid interfering with tests
%test.rate-limit.enabled=false
%e2e.rate-limit.enabled=false

# Production: Consider stricter limits
# %prod.rate-limit.oauth.max-requests=5
# %prod.rate-limit.oauth.window-seconds=60
# %prod.rate-limit.oauth.ban-duration-seconds=600

# https://quarkus.io/guides/management-interface-reference
quarkus.management.enabled=true
quarkus.management.host=localhost
quarkus.management.port=9002
quarkus.management.root-path=/m

quarkus.info.enabled=true
quarkus.info.build.enabled=true
quarkus.info.git.enabled=true
quarkus.info.java.enabled=true
quarkus.info.os.enabled=true

# Add custom properties to the build section
quarkus.info.build.app-name=abstrauth
quarkus.info.build.oauth-redirect-uri=${oauth.google.redirect-uri}

# Build version - injected by Maven during build
build.version=@build.version@
