<div>
  <!-- Client Secret Modal -->
  <div *ngIf="newClientSecret" class="modal-overlay" (click)="closeSecretDialog()">
    <div class="modal-content secret-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>‚ö†Ô∏è Client Secret Created</h2>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <strong>Important:</strong> This is the only time you will see this client secret. 
          Please copy it now and store it securely. You will not be able to retrieve it again.
        </div>
        
        <div class="form-group">
          <label><strong>Client Name:</strong></label>
          <p>{{ newClientName }}</p>
        </div>

        <div class="form-group">
          <label><strong>Client Secret:</strong></label>
          <div class="secret-display">
            <code class="secret-value">{{ newClientSecret }}</code>
            <button type="button" class="btn-copy" (click)="copySecret()" [class.copied]="secretCopied">
              {{ secretCopied ? '‚úì Copied' : 'üìã Copy' }}
            </button>
          </div>
        </div>

        <div class="alert alert-info">
          <strong>Next steps:</strong>
          <ul>
            <li>Store this secret in a secure location (e.g., password manager, environment variables)</li>
            <li>Use this secret when configuring your OAuth client application</li>
            <li>Never commit this secret to version control</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn-primary" (click)="closeSecretDialog()" [disabled]="!secretCopied">
          I have saved the secret
        </button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1>OAuth Clients</h1>
      <button *ngIf="hasManageClientsRole() && !loading" class="btn-add" (click)="toggleForm()"
        [disabled]="formSubmitting">
        {{ showForm ? 'Cancel' : '+ Add Client' }}
      </button>
    </div>

    <div *ngIf="loading" class="loading">
      Loading clients...
    </div>

    <div *ngIf="error" class="error-box">
      {{ error }}
    </div>

    <!-- Add Client Form -->
    <div *ngIf="showForm && hasManageClientsRole()" class="form-container">
      <h2>Create New OAuth Client</h2>

      <form (ngSubmit)="onSubmit()">
        <div *ngIf="formError" class="error-box">
          {{ formError }}
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientId">Client ID *</label>
            <input type="text" id="clientId" name="clientId" [(ngModel)]="formData.clientId" required
              placeholder="e.g., my-app-client" [disabled]="formSubmitting">
            <small class="form-hint">Unique identifier for this client</small>
          </div>

          <div class="form-group">
            <label for="clientName">Client Name *</label>
            <input type="text" id="clientName" name="clientName" [(ngModel)]="formData.clientName" required
              placeholder="e.g., My Application" [disabled]="formSubmitting">
            <small class="form-hint">Human-readable name for this client</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="clientType">Client Type *</label>
            <select id="clientType" name="clientType" [(ngModel)]="formData.clientType" required
              [disabled]="formSubmitting">
              <option value="confidential">Confidential</option>
            </select>
            <small class="form-hint">Confidential for server-side apps or SPAs with BFF</small>
          </div>

          <div class="form-group">
            <label for="requirePkce">
              Require PKCE
            </label>
            <input type="checkbox" id="requirePkce" name="requirePkce" [(ngModel)]="formData.requirePkce"
                [disabled]="true">
            <small class="form-hint">Required by abstrauth</small>
          </div>
        </div>

        <div class="form-group">
          <label for="redirectUris">Redirect URIs * (one per line)</label>
          <textarea id="redirectUris" name="redirectUris" [(ngModel)]="formData.redirectUris" required rows="3"
            placeholder="http://localhost:3000/callback&#10;https://myapp.com/auth/callback"
            [disabled]="formSubmitting"></textarea>
          <small class="form-hint">Valid redirect URIs for this client (one per line)</small>
        </div>

        <div class="form-group">
          <label for="allowedScopes">Allowed Scopes (space or comma separated)</label>
          <input type="text" id="allowedScopes" name="allowedScopes" [(ngModel)]="formData.allowedScopes"
            placeholder="openid profile email" [disabled]="formSubmitting">
          <small class="form-hint">
            <strong>Supported scopes:</strong> <code>openid</code> so that a user token can be generated, <code>profile</code> so that the users name can be read, <code>email</code> so that the users email can be read.<br>
            Leave empty for role-based authorization only (M2M clients). Roles can only be added when no scopes are configured.
          </small>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary" [disabled]="formSubmitting">
            {{ formSubmitting ? 'Creating...' : 'Create Client' }}
          </button>
          <button type="button" class="btn-secondary" (click)="toggleForm()" [disabled]="formSubmitting">
            Cancel
          </button>
        </div>
      </form>
    </div>

    <div *ngIf="!loading && !error && clients.length === 0" class="info-message">
      No OAuth clients found.
    </div>

    <div *ngIf="!loading && !error && clients.length > 0">
      <!-- Filter Section -->
      <url-filter id="clients-filter" [placeholder]="'Filter by name, client ID, type, URI, or scope...'"
        [itemCount]="filteredClients.length" [totalCount]="clients.length" [itemLabel]="'clients'"
        (filterChange)="onFilterChange($event)">
      </url-filter>

      <!-- No Results Message -->
      <div *ngIf="filteredClients.length === 0" class="info-message">
        <p>No clients match your filter criteria.</p>
      </div>

      <div *ngIf="filteredClients.length > 0" class="card-list">
        <div *ngFor="let client of filteredClients" class="card" [attr.data-client-id]="client.clientId">
          <div class="card-header">
            <div>
              <h2>{{ client.clientName }}</h2>
              <span class="badge" [class.badge-primary]="client.clientType === 'public'"
                [class.badge-secondary]="client.clientType === 'confidential'">
                {{ client.clientType }}
              </span>
            </div>
            <div *ngIf="hasManageClientsRole() && editingClientId !== client.id" class="card-actions">
              <button class="btn-icon" (click)="startEdit(client)" title="Edit client"
                [disabled]="editingClientId !== null">
                ‚úèÔ∏è
              </button>
              <button class="btn-icon btn-icon-danger" (click)="deleteClient(client)" title="Delete client"
                [disabled]="editingClientId !== null">
                üóëÔ∏è
              </button>
            </div>
          </div>

          <!-- Edit Form -->
          <div *ngIf="editingClientId === client.id" class="form-container" style="margin-top: 1rem;">
            <h3>Edit Client</h3>

            <form (ngSubmit)="onSubmit()">
              <div *ngIf="formError" class="error-box">
                {{ formError }}
              </div>

              <div class="form-group">
                <label for="edit-clientId">Client ID</label>
                <input type="text" id="edit-clientId" name="clientId" [(ngModel)]="formData.clientId" disabled>
                <small class="form-hint">Client ID cannot be changed</small>
              </div>

              <div class="form-group">
                <label for="edit-clientName">Client Name *</label>
                <input type="text" id="edit-clientName" name="clientName" [(ngModel)]="formData.clientName" required
                  [disabled]="formSubmitting">
              </div>

              <div class="form-group">
                <label for="edit-clientType">Client Type *</label>
                <select id="edit-clientType" name="clientType" [(ngModel)]="formData.clientType" required
                  [disabled]="formSubmitting">
                  <option value="confidential">Confidential</option>
                </select>
              </div>

              <div class="form-group">
                <label for="edit-requirePkce">Require PKCE</label>
                <input type="checkbox" id="edit-requirePkce" name="requirePkce" [(ngModel)]="formData.requirePkce"
                  [disabled]="true">
              </div>

              <div class="form-group">
                <label for="edit-redirectUris">Redirect URIs * (one per line)</label>
                <textarea id="edit-redirectUris" name="redirectUris" [(ngModel)]="formData.redirectUris" required
                  rows="3" [disabled]="formSubmitting"></textarea>
              </div>

              <div class="form-group">
                <label for="edit-allowedScopes">Allowed Scopes (space or comma separated)</label>
                <input type="text" id="edit-allowedScopes" name="allowedScopes" [(ngModel)]="formData.allowedScopes"
                  [disabled]="formSubmitting">
                <small class="form-hint">
                  <strong>Supported scopes:</strong> <code>openid</code> so that a user token can be generated, <code>profile</code> so that the users name can be read, <code>email</code> so that the users email can be read.<br>
                  Leave empty for role-based auth only.
                </small>
              </div>

              <div class="form-actions">
                <button type="submit" class="btn-primary" [disabled]="formSubmitting">
                  {{ formSubmitting ? 'Updating...' : 'Update Client' }}
                </button>
                <button type="button" class="btn-secondary" (click)="cancelEdit()" [disabled]="formSubmitting">
                  Cancel
                </button>
              </div>
            </form>
          </div>

          <div *ngIf="editingClientId !== client.id" class="detail-section">
            <div class="detail-row">
              <span class="label">Client ID:</span>
              <span class="value">{{ client.clientId }}</span>
            </div>

            <div class="detail-row">
              <span class="label">Redirect URIs:</span>
              <ul class="simple-list">
                <li *ngFor="let uri of parseJsonArray(client.redirectUris)">{{ uri }}</li>
              </ul>
            </div>

            <div class="detail-row">
              <span class="label">Allowed Scopes:</span>
              <div class="badge-list" *ngIf="parseJsonArray(client.allowedScopes).length > 0">
                <span *ngFor="let scope of parseJsonArray(client.allowedScopes)" class="badge badge-success">
                  {{ scope }}
                </span>
              </div>
              <span class="value" *ngIf="parseJsonArray(client.allowedScopes).length === 0">
                None (role-based authorization only)
              </span>
            </div>

            <div class="detail-row">
              <span class="label">Requires PKCE:</span>
              <span class="value">{{ client.requirePkce ? 'Yes' : 'No' }}</span>
            </div>

            <div class="detail-row">
              <span class="label">Created:</span>
              <span class="value">{{ client.createdAt }}</span>
            </div>

            <div class="detail-row">
              <span class="label">Accounts:</span>
              <span class="value">
                <a [routerLink]="['/accounts']" [queryParams]="{filter: client.clientId}" class="client-link">
                  View accounts with roles for this client
                </a>
              </span>
            </div>

            <!-- Secret Management Section -->
            <div *ngIf="hasManageClientsRole()" class="detail-row secret-management">
              <button class="btn-secondary" (click)="toggleSecretsView(client)">
                {{ viewingSecretsFor === client.clientId ? 'üîí Hide Secrets' : 'üîë Manage Secrets' }}
              </button>
            </div>

            <!-- Secrets List -->
            <div *ngIf="viewingSecretsFor === client.clientId" class="secrets-section">
              <div class="secrets-header">
                <h3>Client Secrets</h3>
                <button class="btn-primary btn-sm" (click)="toggleCreateSecretForm()" [disabled]="secretsLoading">
                  {{ showCreateSecretForm ? 'Cancel' : '+ Generate New Secret' }}
                </button>
              </div>

              <!-- Create Secret Form -->
              <div *ngIf="showCreateSecretForm" class="form-container secret-form">
                <h4>Generate New Secret</h4>
                <div class="form-group">
                  <label for="secret-description">Description *</label>
                  <input type="text" id="secret-description" [(ngModel)]="createSecretData.description" 
                         placeholder="e.g., Production secret - Jan 2026" required>
                  <small class="form-hint">Describe the purpose or environment for this secret</small>
                </div>
                <div class="form-group">
                  <label for="secret-expiry">Expires in (days)</label>
                  <input type="number" id="secret-expiry" [(ngModel)]="createSecretData.expiresInDays" 
                         placeholder="e.g., 90" min="1">
                  <small class="form-hint">Leave empty for no expiration</small>
                </div>
                <div class="form-actions">
                  <button class="btn-primary" (click)="createSecret(client.clientId)">
                    Generate Secret
                  </button>
                  <button class="btn-secondary" (click)="toggleCreateSecretForm()">
                    Cancel
                  </button>
                </div>
              </div>

              <div *ngIf="secretsLoading" class="loading">Loading secrets...</div>
              <div *ngIf="secretsError" class="error-box">{{ secretsError }}</div>

              <div *ngIf="!secretsLoading && !secretsError && clientSecrets.length === 0" class="info-box">
                No secrets found. Generate a new secret to get started.
              </div>

              <div *ngIf="!secretsLoading && clientSecrets.length > 0" class="secrets-list">
                <div *ngFor="let secret of clientSecrets" class="secret-card" 
                     [class.secret-expired]="isSecretExpired(secret)"
                     [class.secret-expiring]="isSecretExpiringSoon(secret)"
                     [class.secret-inactive]="!secret.active">
                  <div class="secret-header">
                    <div class="secret-info">
                      <strong>{{ secret.description }}</strong>
                      <span class="badge" 
                            [class.badge-success]="secret.active && !isSecretExpired(secret)"
                            [class.badge-warning]="isSecretExpiringSoon(secret)"
                            [class.badge-danger]="isSecretExpired(secret) || !secret.active">
                        {{ secret.active ? (isSecretExpired(secret) ? 'Expired' : 'Active') : 'Revoked' }}
                      </span>
                    </div>
                    <div class="secret-actions">
                      <button *ngIf="secret.active && !isSecretExpired(secret)" 
                              class="btn-icon btn-icon-danger" 
                              (click)="revokeSecret(client.clientId, secret)"
                              title="Revoke secret">
                        üîí Revoke
                      </button>
                      <button *ngIf="!secret.active" 
                              class="btn-icon btn-icon-danger" 
                              (click)="deleteSecret(client.clientId, secret)"
                              title="Permanently delete secret">
                        üóëÔ∏è Delete
                      </button>
                    </div>
                  </div>
                  <div class="secret-details">
                    <div class="secret-detail">
                      <span class="label">Created:</span>
                      <span class="value">{{ formatDate(secret.createdAt) }}</span>
                    </div>
                    <div *ngIf="secret.expiresAt" class="secret-detail">
                      <span class="label">Expires:</span>
                      <span class="value">{{ formatDate(secret.expiresAt) }}</span>
                    </div>
                    <div *ngIf="!secret.expiresAt" class="secret-detail">
                      <span class="label">Expires:</span>
                      <span class="value">Never</span>
                    </div>
                  </div>
                  <div *ngIf="isSecretExpiringSoon(secret) && secret.active" class="alert alert-warning">
                    ‚ö†Ô∏è This secret will expire soon. Generate a new secret before it expires.
                  </div>
                  <div *ngIf="isSecretExpired(secret) && secret.active" class="alert alert-danger">
                    ‚ö†Ô∏è This secret has expired and can no longer be used.
                  </div>
                </div>
              </div>
            </div>

            <!-- Role Management Section (for service clients) -->
            <div *ngIf="hasManageClientsRole()" class="detail-row role-management">
              <button class="btn-secondary" (click)="toggleRolesView(client)" [disabled]="!canManageRoles(client)">
                {{ viewingRolesFor === client.clientId ? 'üë• Hide Roles' : 'üë• Manage Roles' }}
              </button>
              <small class="form-hint" *ngIf="!canManageRoles(client)" style="color: #dc3545; margin-top: 0.5rem; display: block;">
                ‚ö†Ô∏è Roles can only be managed for clients with no scopes configured. Remove all scopes to enable role management.
              </small>
            </div>

            <!-- Roles List -->
            <div *ngIf="viewingRolesFor === client.clientId" class="roles-section">
              <div class="roles-header">
                <h3>Service Account Roles</h3>
                <button class="btn-primary btn-sm" (click)="toggleAddRoleForm()" [disabled]="rolesLoading">
                  {{ showAddRoleForm ? 'Cancel' : '+ Add Role' }}
                </button>
              </div>

              <div class="info-box">
                <strong>About Service Roles:</strong> Roles are included in JWT tokens as the <code>groups</code> claim 
                for use with <code>@RolesAllowed</code> annotations in Java ecosystems. Format: <code>{{ '{' }}clientId{{ '}' }}_{{ '{' }}role{{ '}' }}</code><br>
                <strong>Note:</strong> Roles can only be used with clients that have no scopes configured (role-based authorization only).
              </div>

              <!-- Add Role Form -->
              <div *ngIf="showAddRoleForm" class="form-container role-form">
                <h4>Add New Role</h4>
                <div class="form-group">
                  <label for="role-name">Role Name *</label>
                  <input type="text" id="role-name" [(ngModel)]="addRoleData.role" 
                         placeholder="e.g., api-reader" 
                         pattern="^[a-z0-9-]+$"
                         required>
                  <small class="form-hint">Lowercase letters, numbers, and hyphens only (e.g., api-reader, data-writer)</small>
                </div>
                <div class="form-actions">
                  <button class="btn-primary" (click)="addRole(client.clientId)" [disabled]="!addRoleData.role">
                    Add Role
                  </button>
                  <button class="btn-secondary" (click)="toggleAddRoleForm()">
                    Cancel
                  </button>
                </div>
              </div>

              <div *ngIf="rolesLoading" class="loading">Loading roles...</div>
              <div *ngIf="rolesError" class="error-box">{{ rolesError }}</div>

              <div *ngIf="!rolesLoading && !rolesError && serviceAccountRoles.length === 0" class="info-box">
                No roles assigned.
              </div>

              <div *ngIf="!rolesLoading && serviceAccountRoles.length > 0" class="roles-list">
                <div *ngFor="let role of serviceAccountRoles" class="role-card">
                  <div class="role-header">
                    <div class="role-info">
                      <strong>{{ role }}</strong>
                      <span class="role-group-name">‚Üí {{ client.clientId }}_{{ role }}</span>
                    </div>
                    <div class="role-actions">
                      <button class="btn-icon btn-icon-danger" 
                              (click)="removeRole(client.clientId, role)"
                              title="Remove role">
                        üóëÔ∏è Remove
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>